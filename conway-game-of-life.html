<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Conway's game of life</title>
    <style>
      body {
        background: #0b1a2c;
        color: #e5e7eb;
      }

      canvas {
        border: 1px solid #1f2937;
        background-color: black;
      }
      #canv-container {
        display: flex;
      }
      #popcanv-container {
        width: 700px;
      }
    </style>
  </head>
  <body>
    <p>Generation: <span id="generation-display"></span></p>
    <p>Population: <span id="population-display"></span></p>
    <br />
    <button id="pause-btn">Resume</button>
    <br />
    <div id="canv-container">
      <canvas id="sim-canvas"></canvas>
      <div id="popcanv-container">
        <canvas id="population-canvas"></canvas>
      </div>
    </div>
  </body>
  <script>
    const canvas = document.getElementById("sim-canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = 600;
    canvas.height = 600;

    let generation = 0;
    let paused = true;
    const pauseBtn = document.getElementById("pause-btn");
    pauseBtn.addEventListener("click", () => {
      if (paused) {
        paused = false;
        pauseBtn.innerText = "Pause";
        animate();
      } else {
        paused = true;
        pauseBtn.innerText = "Resume";
      }
    });

    // graph setup
    const populationCtx = document
      .getElementById("population-canvas")
      .getContext("2d");
    const populationChart = new Chart(populationCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Alive Cells",
            data: [],
            borderColor: "cyan",
            backgroundColor: "rgba(0, 255, 255, 0.1)",
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
          },
        ],
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { display: false },
          y: {
            beginAtZero: true,
            grid: { color: "#333" },
          },
        },
      },
    });

    // simulation setup
    class World {
      constructor(width = 100, height = 100) {
        this.width = width;
        this.height = height;
        this.map = [];
        this.new_map = [];
        this.population = 0;
      }

      reset_new_map() {
        this.new_map = [];
        for (let i = 0; i < this.width; i += 1) {
          let li = [];
          for (let j = 0; j < this.height; j += 1) li.push(0);
          this.new_map.push(li);
        }
      }

      update_population(map) {
        let pop = 0;
        for (let i = 0; i < map.length; i++) {
          for (let j = 0; j < map[i].length; j++) {
            if (map[i][j] === 1) pop++;
          }
        }
        return pop;
      }

      init() {
        for (let i = 0; i < this.width; i += 1) {
          let li = [];
          for (let j = 0; j < this.height; j += 1)
            li.push(Math.random() < 0.1 ? 1 : 0);
          this.map.push(li);
        }

        this.population = this.update_population(this.map);

        this.reset_new_map();
      }

      count_alive_neighbours(i, j) {
        // generate neighbour index
        let neighbour_indices = [
          [i - 1, j - 1],
          [i, j - 1],
          [i + 1, j - 1],
          [i + 1, j],
          [i + 1, j + 1],
          [i, j + 1],
          [i - 1, j + 1],
          [i - 1, j],
        ];

        const filtered_neighbour_indices = neighbour_indices.filter((elem) => {
          return !(
            elem[0] < 0 ||
            elem[0] === this.width ||
            elem[1] < 0 ||
            elem[1] === this.height
          );
        });

        const count = filtered_neighbour_indices.filter(
          (index) => this.map[index[0]][index[1]] === 1,
        ).length;

        return count;
      }

      update_map() {
        for (let i = 0; i < this.width; i += 1) {
          for (let j = 0; j < this.height; j += 1) {
            let num_neighbours = this.count_alive_neighbours(i, j);
            if (this.map[i][j] === 1) {
              if (num_neighbours === 2 || num_neighbours === 3)
                this.new_map[i][j] = 1;
              else this.new_map[i][j] = -1;
            } else {
              if (num_neighbours === 3) this.new_map[i][j] = 1;
            }
          }
        }
        this.map = this.new_map;
        world.population = this.update_population(this.map);
        this.reset_new_map();
      }

      draw() {
        for (let i = 0; i < this.width; i += 1) {
          for (let j = 0; j < this.height; j += 1) {
            if (this.map[i][j] === 1) {
              ctx.fillStyle = "green";
              ctx.fillRect(
                (i * canvas.width) / this.width,
                (j * canvas.height) / this.height,
                canvas.width / this.width,
                canvas.height / this.height,
              );
            }
            // else if (this.map[i][j] === -1) {
            //   ctx.fillStyle = "red";
            //   ctx.fillRect(
            //     (i * canvas.width) / this.width,
            //     (j * canvas.height) / this.height,
            //     canvas.width / this.width,
            //     canvas.height / this.height,
            //   );
            // }
          }
        }
      }
    }
    const world = new World();
    world.init();

    function animate() {
      generation += 1;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      world.draw();
      world.update_map();

      //labels
      document.getElementById("generation-display").innerText = generation;
      document.getElementById("population-display").innerText =
        world.population;

      //graph
      populationChart.data.labels.push(generation);
      populationChart.data.datasets[0].data.push(world.population);

      populationChart.update();

      if (!paused) requestAnimationFrame(animate);
    }
  </script>
</html>
